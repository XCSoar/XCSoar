#!/bin/bash

CPUS=$(lscpu -p | tail -n1 | cut -f1 -d,)
(( CPUS++ ))
cd /opt/xcsoar || exit 1

ARGS=($@)
TARGET=${ARGS[0]}
unset "ARGS[0]"

case "${TARGET}" in
      ANDROID)
        make TARGET=ANDROIDFAT -j "${CPUS}" "${ARGS[@]}"
      ;;
      "DOCS")
        make manual -j "${CPUS}" "${ARGS[@]}"
      ;;
      "KOBO")
        make TARGET="${TARGET}" -j"${CPUS}" libs
        make TARGET="${TARGET}" -j"${CPUS}" "${ARGS[@]}"
        make TARGET="${TARGET}" -j"${CPUS}" output/KOBO/KoboRoot.tgz
      ;;
      "WAYLAND" | "UNIX" | "PC" | "WIN64")
        make TARGET="${TARGET}" -j"${CPUS}" "${ARGS[@]}"
      ;;
      "UNIX-SDL")
        make TARGET="UNIX" -j"${CPUS}" OPENGL=n ENABLE_SDL=y USE_SDL2=y "${ARGS[@]}"
      ;;
      "DEBIAN" | "UNIX-DEBIAN")
        TARGET=UNIX DEB_BUILD_OPTIONS=ccache dpkg-buildpackage --jobs-force="${CPUS}" --no-sign "${ARGS[@]}"
        ls ../
      ;;
      "WAYLAND-DEBIAN")
        TARGET=WAYLAND DEB_BUILD_OPTIONS=ccache dpkg-buildpackage --jobs-force="${CPUS}" --no-sign "${ARGS[@]}"
        ls ../
      ;;
      "ALL")
        for target in ANDROID DOCS KOBO WAYLAND UNIX PC WIN64 DEBIAN; do
          "$0" "${target}" "${ARGS[@]}" || true
        done
      ;;
      *)
        echo "No target specified. Valid targets: ANDROID DOCS KOBO WAYLAND UNIX UNIX-SDL PC WIN64 DEBIAN WAYLAND-DEBIAN ALL"
        exit 1
      ;;
esac
